import random
import math
from django.core.management.base import BaseCommand
from core.models import RedBookEntry, Sector
from core.consts import SECTOR_TYPES

# Координаты центра Москвы
CENTER_LAT = 55.758406
CENTER_LON = 37.619788
# Вторая точка для определения радиуса
SECOND_POINT_LAT = 55.061151
SECOND_POINT_LON = 36.064469

# Описание для каждого сектора
sector_descriptions = [
    "Лосиный Остров, национальный парк (в пределах МКАД)",
    "лесопарк «Сокольники» (включая ПИП «Сокольники» и ПКиО)",
    "природно-исторический парк «Измайлово» (3а – Серебряно-Виноградный пруд с Измайловским островом; 3б – Измайловский ПКиО; 3в – Измайловский лес; 3г – Терлецкий лесопарк)",
    "лесопарк «Кусково» (включая ПИП «Кусково» и усадебный парк)",
    "природно-исторический парк «Косинский» (5а – Чёрное озеро с прибрежной зоной; 5б – Белое озеро; 5в – Святое озеро с прибрежной зоной; 5г – междуречье Руднёвки и Чёрной; 5д – междуречье Пахры и Руднёвки)",
    "окрестности ПИП «Косинский» (6а – Суздальский пруд; 6б – Кожуховская котловина)",
    "Жулебинский лесопарк (включая ПЗ «Жулебинский»)",
    "природно-исторический парк «Кузьминки-Люблино» (8а – усадьба «Люблино»; 8б – усадебный парк и ПКиО «Кузьминки»; 8в – Кузьминский лесопарк; 8г – Кузьминский лес)",
    "Нагатинская пойма (включая ЭП «Участок Нагатинской поймы реки Москвы»)",
    "природные территории бассейна Котловки (10а – долина Котловки включая ЛЗ и ПП «Долина реки Котловки»; 10б – долина Коршунихи)",
    "Коломенское, музей-заповедник",
    "Курьяновский берег Москвы-реки",
    "Марьинская пойма (13а – северо-восточная часть, у ул. Марьинский Парк и Чагинской электроподстанции; 13б – Марьинский берег Москвы-реки)",
    "Капотненский берег Москвы-реки",
    "Братеевская пойма с реками Городнёй и Шмелёвкой (включая ФЗ «Братеевская пойма»)",
    "долина Шмелёвки с Кузнецовкой и Соровским ручьём",
    "Зябликовский лесопарк",
    "Каширский пруд с прибрежной зоной",
    "природно-исторический парк «Царицыно» (19а – Нижний Царицынский пруд с Сабуровским заливом и прилегающими землями; 19б – Борисовский пруд с прибрежной зоной; 19в – долина Городни; 19г – Средний Царицынский пруд с прибрежной зоной; 19д – парк музея-заповедника «Царицыно»; 19е – долина Язвенки; 19ж – Бирюлёвский дендропарк; 19з – Бирюлёвский лес; 19и – Бирюлёвские перелески)",
    "усадебный парк «Загорье»",
    "Аннинский лесопарк (включая ПЗ «Аннинский»)",
    "долина Городни (включая ЛЗ «Долина реки Городни»)",
    "залесённая балка в долине Городни",
    "долина Чертановки (включая ЛЗ «Долина реки Чертановки»)",
    "природно-исторический парк «Битцевский лес» (25а – Битцевский лес; 25б – Узкое, лесопарк и усадьба; 25в – усадьба «Ясенево»; 25г – Знаменское-Садки, усадьба и прилегающие земли)",
    "Ботанический сад и опытные поля ВИЛАР",
    "Бутовский лесопарк (27а – вост. часть Бутовского л-ка в границах Москвы; включая ЭП «Северное Бутово»; ранее – «Бутовский лесопарк северный»; 27б – Бутовский лес, центральная часть Бутовского л-ка в границах Москвы)",
    "ЛЗ «Южное Бутово» с прилегающими территориями (ранее – «Бутовский лесопарк южный»)",
    "Новокурьяновский лесопарк и поля (внутри ж.д. кольца)",
    "долина Чечёры в Южном Бутове",
    "долина Корюшки",
    "Рузаев овраг",
    "Ясеневский лесопарк с долиной Битцы",
    "усадебный парк «Малое Голубино»",
    "долина Битцы",
    "Голубинский лесопарк с долиной Битцы",
    "Троицкий лесопарк (включая ПЗ «Троицкий» на его участке внутри МКАД)",
    "Теплостанский лесопарк, ЛЗ «Тёплый Стан»",
    "Юго-Западный лесопарк с долиной Самородинки (включая ЛЗ «Лес на реке Самородинке»)",
    "Воронцовский парк",
    "Центральный парк культуры и отдыха им. М. Горького",
    "Нескучный сад",
    "Воробьёвы горы, природный заказник",
    "Ботанический сад МГУ с Университетским парком",
    "парк на Раменке с участком долины (включая ЛЗ «Долина реки Раменки»)",
    "долина Самородинки",
    "долина Очаковки от Никулинской ул. до устья (включая ЛЗ «Долина реки Очаковки»)",
    "ландшафтный заказник «Тропарёвский» (48а – Тропарёвский луг; 48б – Тропарёвский лес; 48в – Тропарёвский парк)",
    "долина Сетуни (49а – долина Сетуни; 49б – Троекуровский лес с долиной Троекуровского ручья; 49в – долина Навершки; 49г – Кунцевская дача; 49д – Матвеевский лес; 49е – долина Сетуни в Солнцеве и Ново-Переделкине)",
    "Чоботовский лес",
    "долина Алёшинки",
    "Мещерский парк (участок в черте Москвы)",
    "Очаковский сосняк (включая ЗУ «Сосняк на Рябиновой улице»)",
    "долина Раменки (включая ЛЗ «Долина реки Раменки»)",
    "долина Давыдковской речки",
    "природно-исторический парк «Москворецкий» (56а – Фили-Кунцевский лесопарк; 56б – Мнёвниковская пойма; 56в – Карамышевский берег; 56г – Крылатская пойма; 56д – Крылатский берег; 56е – Крылатские холмы; 56ж – Серебряноборское лесничество (южный массив); 56з – Черепковский луг; 56и – Серебряноборское лесничество (средний массив); 56к – Серебряноборское лесничество (северный массив); 56л – усадебный парк «Троице-Лыково»; 56м – Серебряный Бор; 56н – Щукинский полуостров; 56о – Строгинский мыс; 56п – Малая Строгинская пойма; 56р – Строгинский парк; 56с – Строгинский полуостров; 56т – Тушинский берег Москвы-реки; 56у – низовья Химки; 56ф – Рублёвский лесопарк (3 участка); 56х – долины рек Сходни и Муравки с прилегающими землями; 56ц – Митинский лесопарк (4 участка) с долиной Рождественской речки)",
    "Покровское-Стрешнево, природно-исторический парк (57а – лесопарк Покровское-Стрешнево; 57б – Всесвятский лесопарк; 57в – Щукинский лесопарк)",
    "Спасский берег Москвы-реки",
    "долина Синички (включая ЛЗ «Долина реки Синички в Митино»)",
    "природно-исторический парк «Тушинский» (60а – долина Сходни в Митине; 60б – Тушинская Чаша; 60в – усадьба «Братцево» с долиной Сходни; 60г – долина Братовки с прилегающими лугами и Братцевским садом; 60д – Алёшкинский лес; 60е – Тушинский берег Химкинского вдхр.)",
    "Дубовая роща",
    "долина Сходни в Куркине, ландшафтный заказник",
    "долина Сходни в Верескине (включая ЛЗ «Долина реки Сходни в районе Молжаниновский»)",
    "Филинское верховое болото",
    "Молжаниновское верховое болото, памятник природы",
    "Бурцевское переходное болото",
    "долина Клязьмы с правобережными притоками",
    "Вашутинское мезотрофное болото в районе Молжаниновский",
    "Химкинский лесопарк (включая ЛЗ «Химкинский»)",
    "парк Дружбы",
    "фаунистический заказник «Долгие пруды» (71а – Долгопрудненский водно-болотный комплекс; 71б – Новодачный лесопарк; 71в – Виноградовский лесопарк с Долгим прудом)",
    "Долгопрудненский лесопарк",
    "природный заказник «Северный» (73а – Северный лесопарк; 73б – Челобитьевский лесопарк)",
    "Лианозовский лесопарк (включая ЛЗ «Лианозовский»)",
    "комплексный заказник «Алтуфьевский» (75а – долина Алтуфьевской речки; 75б – Алтуфьевский лесопарк с долиной Алтуфьевской речки)",
    "Медведковский лесопарк",
    "долина Ички вне Лосиного Острова",
    "долина Лихоборки",
    "Петровско-Разумовское (79а – Опытные поля РГАУ-МСХА; 79б – усадебный парк «Петровско-Разумовское» и дендросад им. Шредера; 79в – Лесная опытная дача, Тимирязевский парк; 79г – парк «Дубки»)",
    "природно-исторический парк «Останкино» (80а – Останкинская дубрава ГБС РАН и участок леса за Ботанической ул.; 80б – Останкинский парк; 80в – долина Яузы и Леоновская роща; 80г – долина Чермянки; 80д – долина Яузы от МКАД до МЦК)",
    "Всероссийский выставочный центр",
    "долина Яузы между ул. Вильгельма Пика и Лосиным Островом",
    "Ходынское поле",
    "Заповедный луг",
    "Академический парк",
    "Зеленоградский лесопарк (включая КЗ «Зеленоградский», в том числе: 86а – ПП «Малинское верховое болото»; 86б – озеро Чёрное в Зеленограде)",
    "Пойма Москвы-реки ниже Рублёвского гидроузла и Захарковский залив",
    "о.п. Конезавод, ВТБ в окрестностях д. Мозжинка",
    "о.п. Конезавод, ВТБ в окрестностях пос. Николина Гора",
    "Мичуринский пруд с частью Ульяновского лесопарка",
    "Пруд пос. Кирпичного Завода",
    "Долина Ликовы и Марьинский ручей",
    "Долина верхнего течения Зимёнки",
    "поле у с. Нижнее Валуево",
    "Долина Бекетова ручья",
    "Троицкий лес (в составе г. Троицк)",
    "Биостанция «Малинки» ИПЭЭ РАН и её окрестности",
    "Дубровицкий лес и Еринский бор",
    "Долина Лубянки ниже пос. Щапово",
    "Верховья Сохны",
    "Шишкин лес",
    "Рыжовский пруд",
    "Семидонное болото",
    "Лес в окрестностях Юрьевского пруда",
    "Крестовский заповедный лесной участок",
    "Заповедный лесной участок Круги",
    "Ихтиологически ценный участок реки Моча между сёлами Клёново и Ознобишино",
    "Верховья Пахры",
    "Роговский лес",
    "Истоки Соловки",
    "Истоки Молодильни",
    "Клёновский лес",
    "Верховья Липенки",
    "Черноольховый лес",
    "Дубрава с примесью берёзы и осины",
    "Елово-широколиственный и берёзовый лес в бывш. Михайловском л-ве",
    "Елово-липовые леса с примесью ясеня и вяза",
    "Урочище «Поляница»",
    "Хвойно-широколиственные и осиновые леса в бывш. Калининском л-ве (западный участок)",
    "Хвойно-широколиственные и осиновые леса в бывш. Калининском л-ве (восточный участок)",
    "Широколиственные леса в бывш. Крестовском л-ве",
]


# Функция для расчета расстояния между двумя точками (в километрах)
def haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371  # Радиус Земли в километрах
    d_lat = math.radians(lat2 - lat1)
    d_lon = math.radians(lon2 - lon1)
    a = math.sin(d_lat / 2) ** 2 + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(
        d_lon / 2) ** 2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    return R * c


# Рассчитываем радиус в километрах между центром Москвы и второй точкой
radius_70 = haversine_distance(CENTER_LAT, CENTER_LON, SECOND_POINT_LAT, SECOND_POINT_LON)
# Радиус для 30% точек на 10-15 км больше
radius_30 = radius_70 + random.uniform(10, 15)


# Функция для генерации случайных точек в пределах окружности
def generate_random_point(center_lat, center_lon, radius_km):
    # Генерируем случайный угол и расстояние от центра
    angle = random.uniform(0, 2 * math.pi)
    distance = random.uniform(0, radius_km)

    # Переводим расстояние в радианы
    delta_lat = distance / 6371  # Радиус Земли
    delta_lon = delta_lat / math.cos(math.radians(center_lat))

    # Вычисляем новые координаты
    new_lat = center_lat + (delta_lat * math.cos(angle))
    new_lon = center_lon + (delta_lon * math.sin(angle))

    return round(new_lat, 6), round(new_lon, 6)


class Command(BaseCommand):
    help = 'Создание секторов с координатами и их привязка к записям Красной книги'

    def handle(self, *args, **kwargs):
        # Генерация 121 уникального объекта координат
        total_sectors = 121
        coordinates = []

        # 70% точек внутри исходного радиуса
        for _ in range(int(total_sectors * 0.7)):
            lat, lon = generate_random_point(CENTER_LAT, CENTER_LON, radius_70)
            coordinates.append((lat, lon))

        # 30% точек внутри увеличенного радиуса
        for _ in range(int(total_sectors * 0.3)):
            lat, lon = generate_random_point(CENTER_LAT, CENTER_LON, radius_30)
            coordinates.append((lat, lon))

        self.stdout.write(
            self.style.SUCCESS(f'Создано 121 координат: {coordinates[:5]}...'))  # Выводим первые 5 для проверки

        # Создание объектов Sector с координатами, описаниями и кодом
        sectors = []
        for i, (lat, lon) in enumerate(coordinates):
            description = sector_descriptions[i] if i < len(sector_descriptions) else "Описание отсутствует"
            sector = Sector(
                name=f"Сектор {i + 1}",
                latitude=lat,
                longitude=lon,
                description=description,
                sector_type=SECTOR_TYPES.PUBLIC,
                code=f"{i + 1:03d}"
            )
            sector.save()
            sectors.append(sector)

        self.stdout.write(self.style.SUCCESS(f'Создано 121 объект Sector.'))

        # Получение всех записей из базы
        entries = RedBookEntry.objects.all()

        # Привязка секторов к записям Красной книги
        for entry in entries:
            # Выбираем от 2 до 5 случайных секторов из списка
            num_sectors = random.randint(2, 5)
            chosen_sectors = random.sample(sectors, num_sectors)

            # Привязываем выбранные секторы к записи
            entry.sector.add(*chosen_sectors)
            entry.save()

            self.stdout.write(self.style.SUCCESS(
                f'Запись {entry.name} привязана к секторам: {", ".join([sector.name for sector in chosen_sectors])}'))

        self.stdout.write(self.style.SUCCESS(f'Координаты успешно привязаны к записям Красной книги.'))
